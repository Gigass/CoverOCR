# CoverOCR 技术栈与架构设计（V1.1）

## 1. 文档目的
- 基于“可复用公开模型，快速跑通文字+字体识别”的目标，给出最小实现方案；
- 聚焦实拍书本封面的 **文字检测识别** 与 **字体识别**，不再做封面分类，仅需返回文字内容及字体类型即可完成演示；
- 说明后续若扩展到自研模型、封面识别或数据闭环时的可演进路径。

## 2. 技术栈设计

### 2.1 语言与框架
| 层级 | 技术 | 选择理由 |
|------|------|----------|
| 前端 GUI | **React + Vite + TypeScript**, Ant Design 组件库 | 生态成熟，上手快；AntD 提供上传、结果卡片、Skeleton 等控件；Vite 支持快速迭代。 |
| 后端 API | **FastAPI (Python 3.11)** | 异步 IO 适合并发上传；Pydantic 便于构建请求/响应模型；与 Python ML 生态无缝衔接。 |
| 模型训练 | **PyTorch + PyTorch Lightning** | Lightning 规范化训练流程，便于复现；PyTorch 具备丰富的预训练模型。 |
| 推理服务 | **TorchServe / FastAPI 内嵌推理 + ONNX Runtime（可选）** | TorchServe 支持 GPU Batch 推理；ONNX Runtime 可在 CPU 环境加速。 |
| 数据标注 | **Label Studio / Roboflow** | 快速构建文字区域、字体标签，支持协作。 |
| 任务编排 | **Prefect / Airflow（可按需）** | 统一训练、评估、部署流水线。 |

### 2.2 模型与库
| 模块 | 建议模型/库 | 补充说明 |
|------|-------------|----------|
| 文字检测 | **PaddleOCR PP-OCRv4 Detection** | 直接复用官方中文通用模型，适配实拍场景，无需额外训练。 |
| 文字识别 | **PaddleOCR PP-OCRv4 Recognition** | 支持中英文混排，内含语言模型纠错；部署即可达到 ≥80% 识别率。 |
| 字体识别 | **PaddleClas Font Recognition / ResNet18 预训练模型** | 直接复用公开字体模型，涵盖宋体、黑体、仿宋、楷体、Arial、Times 等常见字体。 |
| OCR Pipeline | **PaddleOCR Python API / paddleocr==2.x** | 提供一键式检测+识别组合，并能输出文字框、文字内容与置信度。 |
| 字体推理辅助 | **PaddleClas inference** | 将 OCR 裁剪图像输入字体分类模型，无需重新训练即可输出字体标签。 |

### 2.3 数据与存储
| 功能 | 技术 | 说明 |
|------|------|------|
| 训练数据存储 | **MinIO / S3 兼容对象存储** | 统一管理原始与标注图像，支持版本化。 |
| 元数据/标签 | **PostgreSQL** | 存储书目、字体、标注任务状态；JSONB 字段记录检测框。 |
| 嵌入检索（可选） | **Milvus / FAISS** | 用于封面相似度搜索、近似匹配。 |
| 配置与实验 | **DVC + Git** | 跟踪数据版本和模型权重；实验参数写入 YAML。 |

### 2.4 部署与基础设施
- **容器化**：使用 Docker 打包前端、后端、推理服务；通过 Docker Compose 或 Kubernetes 管理。
- **硬件**：推理节点建议配备 1×NVIDIA T4/A10；CPU 场景可使用 ONNX INT8 模型。
- **CI/CD**：GitHub Actions 进行单元测试、模型精度校验、Docker 构建；推送至私有容器仓库。
- **监控**：Prometheus + Grafana 监测 QPS、时延、GPU 利用率；Sentry 捕获前端/后端异常。

## 3. 系统架构设计

### 3.1 总体架构
```
用户浏览器
    │
    ▼
React GUI (Vite) ──> FastAPI 网关 ──> 推理编排器
                                    │
               ┌────────────────────┼────────────────────┐
               ▼                    ▼                    ▼
        文字检测服务         文字识别服务           字体分类服务
               │                    │                    │
               └─────────► 结果融合器 ◄──────────────────┘
                                    │
                            PostgreSQL / MinIO
```
- **推理编排器**：一个 Python Service（可内置于 FastAPI 或独立微服务），负责调用各个模型、缓存结果，并执行超时控制（<10s）。
- **结果融合器**：统一封面 ID、文字行列表、字体标签，并返回给前端。
- **数据持久层**：存储上传历史、推理日志与模型版本信息，方便回溯与再训练。

### 3.2 模块划分
| 模块 | 功能 | 输入/输出 |
|------|------|-----------|
| Upload Handler | 接收上传图像，进行尺寸/类型校验，写入对象存储（可选） | 输入：JPG/PNG；输出：存储路径或内存字节流 |
| Preprocessor | 图像重采样、去噪、颜色校正、矩形校正 | 输入：原图；输出：标准化图像 |
| Text Detector | 产出文字区域多边形 | 输入：标准化图像 | 输出：`List[Polygon]` |
| Text Recognizer | 逐区域识别文字内容 | 输入：裁剪文字块 | 输出：`List[str]` |
| Font Classifier | 对文字块预测字体类型 | 输入：裁剪文字块 | 输出：`List[font_label]` |
| Result Aggregator | 将文字内容、字体标签映射为 API 响应 | 输入：各模块输出 | 输出：JSON 结构 |
| Admin Console（可选） | 标注审核、模型状态监控 | 输入：用户操作 | 输出：管理报告 |

### 3.3 关键流程（推理路径）
1. **上传阶段**：前端使用 AntD `Upload` 组件；文件通过 FastAPI `POST /api/v1/upload` 上传。限制 20MB，自动生成请求 ID。
2. **预处理**：后端进行 EXIF 旋转校正、尺寸缩放 (短边 640)、直方图均衡；缓存至 `/tmp` 或 Redis。
3. **文字检测与识别**：直接调用 PaddleOCR 检测+识别接口，获取文字框、文字内容及置信度。
4. **字体识别**：复用检测框裁剪出的文字块，批量输入 PaddleClas 字体分类模型；输出字体标签和置信度。
5. **结果融合与返回**：生成结构化 JSON，包括每段文字、识别字体、置信度、耗时等。前端展示结果列表、标签以及 OCR 区域（后续可加高亮）。

## 4. 图形界面设计要点
- **布局**：左右两栏。左侧为上传、拍照指南、历史记录；右侧显示图像预览与识别结果。
- **关键组件**：
  - `UploadCard`：支持拖拽、拍照（移动端调起相机），展示上传进度条。
  - `PreviewCanvas`（待扩展）：用 fabric.js 或 Konva 渲染文字框，点击高亮对应结果行。
  - `ResultTabs`：Tab1 显示文字内容（包含字体标签、置信度）；Tab2 显示字体分布（标签云 / 柱状图）。
  - `LatencyIndicator`：顶部显示总耗时，>8s 时提示“建议重新拍摄”。
- **交互细节**：上传后展示 Skeleton，结果到齐前逐步填充；失败时提供重试按钮并上传日志 ID。

## 5. 快速实现路线（MVP）
1. **模型复用**：首版直接使用 PaddleOCR 中文通用模型与 PaddleClas 字体分类模型，无需自训；可在 CPU 环境运行完成演示。
2. **部署**：本机或 Docker Compose 启动 `frontend`（Vite）、`backend`（FastAPI）。若字体模型较大，可独立成推理服务或使用 ONNX Runtime 加速。
3. **数据闭环（可选）**：将上传样本及识别结果写入 MinIO + PostgreSQL，供后续审核与再训练；MVP 阶段可先存内存/本地。
4. **性能优化**：并行化 OCR 与字体识别；缓存常用字体模型；对图像尺寸做裁剪/压缩，确保单张图 10 秒内返回。

## 6. 验收指标对应
| 需求项 | 技术实现映射 |
|--------|--------------|
| 文字识别准确率 ≥80% | PaddleOCR PP-OCRv4 直接部署；必要时增加语义纠错模块。 |
| 字体识别准确率 ≥70% | PaddleClas 字体模型，覆盖常见中英文字体并输出置信度。 |
| 10 秒内返回 | FastAPI 异步 + PaddleOCR Batch 推理；必要时导出 ONNX/INT8。 |
| 实拍鲁棒性 | 上传前预处理（旋转、亮度矫正）、多角度数据增强，确保实拍照片可识别。 |

## 7. 后续扩展
- 新书籍/封面识别：未来可追加封面分类模块或相似度检索，复用现有上传链路。
- 新语言：在 OCR 模型中切换多语模型，并扩充字体分类器标签。
- 移动端：封装 React Native 或 Flutter 壳，将 FastAPI 暴露的 REST API 直接复用。
- SaaS 化：多租户隔离、鉴权（JWT + OAuth2），并加入计费与限流。

> 以上方案兼顾快速落地与长远扩展，团队可按此文档拆解任务、搭建开发环境并启动实现。
