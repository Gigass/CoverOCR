<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoverOCR å­—ä½“æ ‡æ³¨å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .main {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            padding: 30px;
        }
        
        .image-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .image-container {
            position: relative;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        #preview-image {
            width: 100%;
            display: block;
        }
        
        .bbox {
            position: absolute;
            border: 3px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bbox:hover {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        
        .bbox.selected {
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.3);
        }
        
        .bbox-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .annotation-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            max-height: 800px;
            overflow-y: auto;
        }
        
        .upload-section {
            margin-bottom: 20px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 500;
        }
        
        .file-input-label:hover {
            transform: translateY(-2px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .region-list {
            margin-top: 20px;
        }
        
        .region-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .region-item:hover {
            transform: translateX(5px);
            border-color: #667eea;
        }
        
        .region-item.selected {
            border-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .region-text {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .region-meta {
            font-size: 12px;
            color: #666;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #51cf66;
            color: white;
        }
        
        .btn-success:hover {
            background: #40c057;
        }
        
        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stats-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š CoverOCR å­—ä½“æ ‡æ³¨å·¥å…·</h1>
            <p>ä¸Šä¼ æ•™æå°é¢å›¾ç‰‡ï¼Œæ ‡æ³¨æ–‡å­—åŒºåŸŸçš„å­—ä½“å’Œå­—å·</p>
        </div>
        
        <div class="main">
            <div class="image-panel">
                <div class="upload-section">
                    <div class="file-input-wrapper">
                        <input type="file" id="image-upload" accept="image/*">
                        <label for="image-upload" class="file-input-label">
                            ğŸ“¤ é€‰æ‹©å›¾ç‰‡ä¸Šä¼ 
                        </label>
                    </div>
                </div>
                
                <div class="image-container" id="image-container">
                    <img id="preview-image" style="display: none;">
                </div>
            </div>
            
            <div class="annotation-panel">
                <div class="stats">
                    <div class="stats-number" id="region-count">0</div>
                    <div class="stats-label">æ–‡å­—åŒºåŸŸ</div>
                </div>
                
                <div id="annotation-form" style="display: none;">
                    <h3 style="margin-bottom: 15px;">å½“å‰é€‰ä¸­åŒºåŸŸ</h3>
                    
                    <div class="form-group">
                        <label>æ–‡å­—å†…å®¹</label>
                        <input type="text" id="text-content" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>å­—ä½“ç±»åˆ«</label>
                        <select id="font-family">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="å®‹ä½“">å®‹ä½“</option>
                            <option value="é»‘ä½“">é»‘ä½“</option>
                            <option value="æ¥·ä½“">æ¥·ä½“</option>
                            <option value="ä»¿å®‹">ä»¿å®‹</option>
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å­—å·åç§°</label>
                        <select id="font-size-name">
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="åˆå·">åˆå· (42pt)</option>
                            <option value="å°åˆ">å°åˆ (36pt)</option>
                            <option value="ä¸€å·">ä¸€å· (26pt)</option>
                            <option value="å°ä¸€">å°ä¸€ (24pt)</option>
                            <option value="äºŒå·">äºŒå· (22pt)</option>
                            <option value="å°äºŒ">å°äºŒ (18pt)</option>
                            <option value="ä¸‰å·">ä¸‰å· (16pt)</option>
                            <option value="å°ä¸‰">å°ä¸‰ (15pt)</option>
                            <option value="å››å·">å››å· (14pt)</option>
                            <option value="å°å››">å°å›› (12pt)</option>
                            <option value="äº”å·">äº”å· (10.5pt)</option>
                            <option value="å°äº”">å°äº” (9pt)</option>
                            <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ç£…å€¼ (Point Size)</label>
                        <input type="number" id="point-size" step="0.5" min="5" max="100" placeholder="å¦‚: 22">
                    </div>
                    
                    <div class="form-group">
                        <label>æ ‡æ³¨ç½®ä¿¡åº¦</label>
                        <select id="confidence">
                            <option value="high">é«˜ (éå¸¸ç¡®å®š)</option>
                            <option value="medium">ä¸­ (åŸºæœ¬ç¡®å®š)</option>
                            <option value="low">ä½ (ä¸å¤ªç¡®å®š)</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveAnnotation()">ğŸ’¾ ä¿å­˜æ ‡æ³¨</button>
                </div>
                
                <div class="region-list" id="region-list"></div>
                
                <button class="btn btn-success" onclick="exportJSON()" style="margin-top: 20px;">
                    ğŸ“¥ å¯¼å‡º JSON
                </button>
            </div>
        </div>
    </div>
    
    <script>
        let currentImage = null;
        let regions = [];
        let selectedRegionIndex = null;
        
        document.getElementById('image-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.getElementById('preview-image');
                img.src = event.target.result;
                img.style.display = 'block';
                currentImage = {
                    name: file.name,
                    data: event.target.result
                };
                
                // è°ƒç”¨ OCR API è·å–æ–‡å­—åŒºåŸŸ
                callOCRAPI(file);
            };
            reader.readAsDataURL(file);
        });
        
        async function callOCRAPI(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('book_size', '16k');
            
            try {
                const uploadRes = await fetch('http://localhost:8000/api/v1/upload', {
                    method: 'POST',
                    body: formData
                });
                const { request_id } = await uploadRes.json();
                
                // è½®è¯¢è·å–ç»“æœ
                let attempts = 0;
                const pollResult = setInterval(async () => {
                    attempts++;
                    const resultRes = await fetch(`http://localhost:8000/api/v1/result/${request_id}`);
                    if (resultRes.ok) {
                        const result = await resultRes.json();
                        clearInterval(pollResult);
                        loadRegions(result.texts);
                    } else if (attempts > 10) {
                        clearInterval(pollResult);
                        alert('OCR è¯†åˆ«è¶…æ—¶ï¼Œè¯·é‡è¯•');
                    }
                }, 1500);
            } catch (err) {
                console.error('OCR API è°ƒç”¨å¤±è´¥:', err);
                alert('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ï¼Œè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨');
            }
        }
        
        function loadRegions(texts) {
            const img = document.getElementById('preview-image');
            const container = document.getElementById('image-container');
            
            // æ¸…é™¤æ—§çš„è¾¹ç•Œæ¡†
            container.querySelectorAll('.bbox').forEach(el => el.remove());
            
            regions = texts.map((text, index) => ({
                index,
                text: text.content,
                bbox: text.box || [[0,0],[0,0],[0,0],[0,0]], // OCR è¿”å›çš„åæ ‡
                font_family: '',
                font_size_name: '',
                point_size: text.point_size || 0,
                confidence: 'medium'
            }));
            
            // ç»˜åˆ¶è¾¹ç•Œæ¡†
            regions.forEach((region, index) => {
                const bbox = region.bbox;
                const xs = bbox.map(p => p[0]);
                const ys = bbox.map(p => p[1]);
                const x = Math.min(...xs);
                const y = Math.min(...ys);
                const w = Math.max(...xs) - x;
                const h = Math.max(...ys) - y;
                
                const div = document.createElement('div');
                div.className = 'bbox';
                div.dataset.index = index;
                div.style.left = `${x}px`;
                div.style.top = `${y}px`;
                div.style.width = `${w}px`;
                div.style.height = `${h}px`;
                
                const label = document.createElement('div');
                label.className = 'bbox-label';
                label.textContent = region.text.substring(0, 10);
                div.appendChild(label);
                
                div.onclick = () => selectRegion(index);
                container.appendChild(div);
            });
            
            updateRegionList();
            document.getElementById('region-count').textContent = regions.length;
        }
        
        function selectRegion(index) {
            selectedRegionIndex = index;
            const region = regions[index];
            
            // æ›´æ–°è¾¹ç•Œæ¡†æ ·å¼
            document.querySelectorAll('.bbox').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });
            
            // æ›´æ–°è¡¨å•
            document.getElementById('annotation-form').style.display = 'block';
            document.getElementById('text-content').value = region.text;
            document.getElementById('font-family').value = region.font_family;
            document.getElementById('font-size-name').value = region.font_size_name;
            document.getElementById('point-size').value = region.point_size;
            document.getElementById('confidence').value = region.confidence;
            
            updateRegionList();
        }
        
        function saveAnnotation() {
            if (selectedRegionIndex === null) return;
            
            const region = regions[selectedRegionIndex];
            region.font_family = document.getElementById('font-family').value;
            region.font_size_name = document.getElementById('font-size-name').value;
            region.point_size = parseFloat(document.getElementById('point-size').value);
            region.confidence = document.getElementById('confidence').value;
            
            updateRegionList();
            alert('âœ… æ ‡æ³¨å·²ä¿å­˜');
        }
        
        function updateRegionList() {
            const list = document.getElementById('region-list');
            list.innerHTML = '<h3 style="margin-bottom: 15px;">æ–‡å­—åŒºåŸŸåˆ—è¡¨</h3>';
            
            regions.forEach((region, index) => {
                const div = document.createElement('div');
                div.className = 'region-item';
                if (index === selectedRegionIndex) div.classList.add('selected');
                
                const isAnnotated = region.font_family && region.font_size_name;
                const status = isAnnotated ? 'âœ…' : 'â³';
                
                div.innerHTML = `
                    <div class="region-text">${status} ${region.text}</div>
                    <div class="region-meta">
                        ${region.font_family || 'æœªæ ‡æ³¨'} Â· 
                        ${region.font_size_name || 'æœªæ ‡æ³¨'} Â· 
                        ${region.point_size || '?'}pt
                    </div>
                `;
                div.onclick = () => selectRegion(index);
                list.appendChild(div);
            });
        }
        
        function exportJSON() {
            const img = document.getElementById('preview-image');
            const data = {
                image_path: currentImage?.name || 'unknown.jpg',
                image_width: img.naturalWidth,
                image_height: img.naturalHeight,
                book_size: '16k',
                annotations: regions.map(r => ({
                    text: r.text,
                    bbox: [
                        Math.min(...r.bbox.map(p => p[0])),
                        Math.min(...r.bbox.map(p => p[1])),
                        Math.max(...r.bbox.map(p => p[0])),
                        Math.max(...r.bbox.map(p => p[1]))
                    ],
                    font_family: r.font_family,
                    font_size_name: r.font_size_name,
                    point_size: r.point_size,
                    confidence: r.confidence
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `annotation_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
